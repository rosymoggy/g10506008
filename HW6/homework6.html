<html>
<head>
	<title></title>
	<style type="text/css">
		body {
	  background-color: #fff;
	  color: #111;
	  margin: 0px;
	  overflow: hidden;
	  font-family: Monospace;
	  font-size: 20px;
	}
	
	#info {
	  position: absolute;
	  top: 0px;
	  width: 100%;
	  padding: 5px;
	  text-align: center;
	  color: #ffff00
	}
	
	a {
	  color: #00ffff
	}
	
	strong {
	  color: red
	}
	
	#container {
	  z-index: 0;
	  left: 0px;
	  top: 0px;
	  overflow: hidden;
	  position: absolute;
	  width: 100%;
	  height: 100%;
	}
  
  .slider {
    margin: 20px;
    padding: 5px;
    text-align: center;
    width: 100%;
  }
</style>
</head>
<body>
<div id="info">
  Softball Pitcher
  <div id="score1">Score: 0</div>
  <button id="thtrow" style="width:20%">throw</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
<script src="https://rawgit.com/jyunming-chen/game3js/master/js/ccdbox.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>

<script>
var score = 0;
var scene, renderer, camera;
var controls;
var lowerArm, upperArm;
var clock = new THREE.Clock();

var sign = 1;
var zz = 30;

var gcontrols;
var theta1 = 0,
  theta2 = 0,
  theta3 = 0;
var tsphere;
var dt = 0;
var torsoTurn = 0;

var axes = [];
var joints = [];

var box;
var tsbox = new THREE.Vector3();
var ballpoint = new THREE.Vector3();
var pos, vel, force;
var userPos = new THREE.Vector3(-30, 35, -20);
var poskey = false;

init();
animate();

$("#thtrow").click(
  function() {
  	createTsphere();
  }
);
////////////////////////////////////////////////////////
function showScore() {
	var s = "Score: "+score;
	document.getElementById('score1').innerHtml = s;
	console.log("Score: "+score);
}
////////////////////////////////////////////////////////
// forward kinematics
function fk(q, joints) {
  // joint[0]: shoulder
  // joint[1]: elbow
  // joint[2]: hand
  //	joints[0] = new THREE.Vector3(0,0,0);
  var m = new THREE.Matrix4();

  // from home plate
  var localzero = new THREE.Vector3(0, 0, 0);
  m.makeTranslation(0, 0, -35);
  m.multiply(new THREE.Matrix4().makeRotationY(torsoTurn));
  m.multiply(new THREE.Matrix4().makeTranslation(-25, 100, 0));
  localzero.applyMatrix4(m);
  joints[0].copy(localzero);

  m.multiply (new THREE.Matrix4().makeRotationZ(q[0]));
  m.multiply(new THREE.Matrix4().makeRotationX(q[1]));
  m.multiply(new THREE.Matrix4().makeTranslation(0, -40, 0));
  localzero.set(0, 0, 0);
  localzero.applyMatrix4(m);
  joints[1].copy(localzero);

  m.multiply(new THREE.Matrix4().makeRotationX(q[2]));
  m.multiply(new THREE.Matrix4().makeTranslation(0, -60, 0));
  localzero.set(0, 0, 0);
  localzero.applyMatrix4(m);
  joints[2].copy(localzero);
}

/////////////////////////////////////////////////////////////
// joint axis setup
//
function setarm() {
  var axis = new CCD_axis(new THREE.Vector3(0, 0, 1), 0);
  axis.limits = new THREE.Vector2 (-6, 0); 
  axes.push(axis);
  var axis = new CCD_axis(new THREE.Vector3(1, 0, 0), 0);
  axis.limits = new THREE.Vector2 (-1.5,1.5); 
  axes.push(axis);
  var axis = new CCD_axis(new THREE.Vector3(1, 0, 0), 1);
 // axis.limits = new THREE.Vector2(-0.7, -0.01);
  axes.push(axis);
}

function createBody() {
  var boxGeometry = new THREE.BoxGeometry(50, 100, 30);
  body = new THREE.Object3D();
  var bodyMesh = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x5599FF} ));
  bodyMesh.position.set(0, 50, 0);
  body.add(bodyMesh);
  boxGeometry = new THREE.BoxGeometry(26, 26, 26);
  head = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x00DDAA} ));
  head.position.set(0, 113, 0);
  body.add(head);
  scene.add(body);
  body.position.set(0, 0, -40);

  var boxGeometry = new THREE.BoxGeometry(10, 40, 10);
  var arm1_1 = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x33CCFF} ));
  upperArm = new THREE.Object3D();
  upperArm.add(arm1_1);
  arm1_1.position.set(-5, -20, 0);
  body.add(upperArm);
  upperArm.position.set(-25, 100, 0);

  boxGeometry = new THREE.BoxGeometry(10, 60, 10);
  var arm1_2 = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x33CCFF} ));
  lowerArm = new THREE.Object3D();
  lowerArm.position.set(0, -40, 0);
  upperArm.add(lowerArm);
  lowerArm.add(arm1_2);
  arm1_2.position.set(-5, -30, 0);

  boxGeometry = new THREE.BoxGeometry(10, 40, 10);
  var arm2_1 = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x33CCFF} ));
  upperArm2 = new THREE.Object3D();
  upperArm2.add(arm2_1);
  arm2_1.position.set(-5, -20, 0);
  body.add(upperArm2);
  upperArm2.position.set(35, 100, 0);

  boxGeometry = new THREE.BoxGeometry(10, 60, 10);
  var arm2_2 = new THREE.Mesh(boxGeometry, new THREE.MeshPhongMaterial( {color: 0x33CCFF} ));
  lowerArm2 = new THREE.Object3D();
  lowerArm2.position.set(0, -40, 0);
  upperArm2.add(lowerArm2);
  lowerArm2.add(arm2_2);
  arm2_2.position.set(-5, -30, 0);
  upperArm2.rotation.z = Math.PI/36;
  upperArm2.rotation.order = 'ZXY';
  lowerArm2.rotation.x = -Math.PI/9;
}
var tsphereAction = true;
function createTsphere() {
  tsphere = new THREE.Mesh(new THREE.SphereGeometry(5, 20, 20), new THREE.MeshNormalMaterial());
  scene.add (tsphere);
  pos = userPos.clone();
  vel = new THREE.Vector3(0, 30, 50);
  force = new THREE.Vector3(0, 0, 0);
  tsphere.position.copy(pos);
  poskey = false;
}


function createTsphereBox () {
  box = new THREE.Object3D();
  var tb = new THREE.Mesh( new THREE.CylinderGeometry( 24, 16, 32, 48, 20, true), new THREE.MeshPhongMaterial( {color: 0xffff00, side: THREE.DoubleSide} ));
  var bottom = new THREE.Mesh( new THREE.RingGeometry( 0.001, 16, 32 ), new THREE.MeshPhongMaterial( { color: 0xffff00, side: THREE.DoubleSide } ) );
  box.add(tb);
  box.add(bottom);
  scene.add(box);
  tb.position.y = 16;
  bottom.rotation.x = Math.PI/2;
  bottom.position.y = 0.5;
  var x, z;
  do {
  	x = Math.random() * 400-200;
  } while (x > -20 && x < 20);
  do {
  	z = Math.random() * 400-200;
  } while (z < 20);
  
  box.position.set(-20, 0, z);
  tsbox = box.position.clone();
}

////////////////////////////////////////////////////////////////

function init() {
  var width = window.innerWidth;
  var height = window.innerHeight;

  renderer = new THREE.WebGLRenderer({
    antialias: true
  });
  renderer.setSize(width, height);
  renderer.setClearColor(0x888888);

  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();

  camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 10000);
  camera.position.y = 360;
  camera.position.z = 800;
  camera.lookAt(new THREE.Vector3(0, 0, 0));
  scene.add(camera);

  controls = new THREE.OrbitControls(camera, renderer.domElement);

  createBody();
  createTsphere();
  createTsphereBox();

  var gridXZ = new THREE.GridHelper(400, 10);
  gridXZ.setColors(new THREE.Color(0xff0000), new THREE.Color(0xffffff));
  scene.add(gridXZ);
  
  window.addEventListener('resize', onWindowResize, false);

  var light = new THREE.DirectionalLight( 0xFFFFFF );
	light.position.set( 200, 200, 200 ).normalize();
	scene.add(light);

  setarm();
  for (var i = 0; i < 3; i++)
    joints[i] = new THREE.Vector3();

  gcontrols = {
    UserPosX: 0.1,
    UserPosY: 0.1,
    UserPosZ: 0.1,
    Force: 40,
    Height: 30,
    //RoleRotation: 0,
  };
  var gui = new dat.GUI();
  gui.domElement.id = 'gui';
  gui.add(gcontrols, 'UserPosX', 0, 100);
  gui.add(gcontrols, 'UserPosY', 0, 150);
  gui.add(gcontrols, 'UserPosZ', 0, 100);
  gui.add(gcontrols, 'Force', 0, 50);
  gui.add(gcontrols, 'Height', 0, 60);
  //gui.add(gcontrols, 'RoleRotation', 0, 360);
}


function animate() {
  requestAnimationFrame(animate);
  update();
  render();
}
var count = 0, prerot = -1;
var boom = false;
function update() {
  controls.update();
   
  dt = 5*clock.getDelta();
  /* 
  count++;
  console.log ('count: '+ count);
  if(count % 10 == 0) {
  	var ballc = tsphere.clone();
  	scene.add(ballc);
  }*/
  vel.add(force.clone().multiplyScalar(dt));
  pos.add(vel.clone().multiplyScalar(dt));

  force.y = gcontrols.Force-50;
  
 /* var rot = gcontrols.RoleRotation;
  body.rotation.y = Math.PI/180*rot;
  userPos = body.position.clone();
  //var tmp = body.clone();
  body.updateMatrixWorld();

  if(prerot < 0) {
  	prerot = rot;
  } else {
  	if(prerot != rot) {
	  	var vector = new THREE.Vector3();
	  	vector.setFromMatrixPosition( upperArm.matrixWorld );
	  	pos.set(vector.x, vector.y, vector.z);
  	}
  	prerot = rot;
  	//userPos.set(vector.x*Math.cos(Math.PI/180*rot),0, -40+vector.z*Math.sin(Math.PI/180*rot));
  }*/

 
  if( (pos.length()-tsbox.length()) <= 20 && (pos.length()-tsbox.length()) >= 10) {
  	if(pos.y < 32) {
  		boom = true;
  	}
  }
  var target;
  if (pos.y <= 0) {
    force.y = 0;
    vel.set(0, 0, 0);
   //console.log(pos.length()-tsbox.length());
    if( (pos.length()-tsbox.length()) < 10 && !poskey) {
    	poskey = true;
    	var tsz;
    	do {
		  	tsz = Math.random() * 200;
		} while (tsz < 20);
    	tsbox.z = tsz;
    	box.position.set(-20, 0, tsz);
    	vel.y = gcontrols.Height;
    	if(boom) {
    		score --;
    		console.log("Boom tsphere box");
    	} else {
	    	score += 10;
	    }
    	showScore();
    	boom = false;
    }
    userPos.set(-25-gcontrols.UserPosX, gcontrols.UserPosY, -30+gcontrols.UserPosZ);
    
    target = userPos;
  } else {
    target = pos;
    //userPos = lowerArm.position.clone();
    tsphere.position.copy (target);
  }


  //	var theta = [theta1, theta2, theta3];
  var theta = [0, 0, -1e-2];
  ik_ccd(target, theta);
  theta1 = theta[0];
  theta2 = theta[1];
  theta3 = theta[2];
 /// console.log(theta);
 
// 	theta1 = theta2 = theta3 = 0;
//  theta1 = -Math.PI/6;  theta2 = -Math.PI/3;  theta3 = -Math.PI/4;
}

function onWindowResize() {
  var width = window.innerWidth,
    height = window.innerHeight;
  camera.aspect = width / height;
  camera.updateProjectionMatrix();
  renderer.setSize(width, height);
}


function render() {
  upperArm.rotation.z = theta1; //-Math.PI/6;//theta1;
  upperArm.rotation.x = theta2; //-Math.PI/3;//theta2;
  upperArm.rotation.order = 'ZXY';

  lowerArm.rotation.x = theta3; //-Math.PI/4;//theta3;
  //	arm2.position.set (20+30*Math.cos(theta3), 0, -30*Math.sin(theta3));

  renderer.render(scene, camera);
}

</script>

</body>
</html>